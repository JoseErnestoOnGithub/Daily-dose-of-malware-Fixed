import pyvirtualdisplay
from selenium import webdriver
import datetime
from .results import export
from .colors import bcolors

timestamp_now = datetime.datetime.now().strftime('%Y-%m-%d')


def google(export_bool=False, output_bool=False):
    dorks = {"Pony": ["intitle:Authorization inurl:panel*/admin.php intext:Authorization. Sign in.",
                      "intitle:Authorization inurl:panel*/*admin.php",
                      "intitle:Authorization inurl:*admin.php Authorization. User Password Save password. Login. TF."],
             "WannaCry": "intitle:\"index of\" \"@Please_Read_Me@.txt",
             "Stealer": "intitle:\"(c) Bilal Ghouri\"",
             "LokiBot": "inurl:PvqDq929BSx_A_D_M1n_a.php intitle:Auth",
             "1ms0rry": "intitle:1ms0rry MINERPANEL",
             "SpyEye": "intitle:FRMCP intext:Please, enter password"}

    print(bcolors.OKBLUE + "++++++++++++++++++++++++++++++++++")
    print("Google dorks")
    print("++++++++++++++++++++++++++++++++++" + bcolors.ENDC)

    info = {}
    links_list = []

    display = pyvirtualdisplay.Display(visible=0, size=(800, 600))
    display.start()

    directory = "google" + timestamp_now
    # now Firefox will run in a virtual display.
    # you will not see the browser.
    browser = webdriver.Firefox()
    for i in dorks.keys():  # for every dork in dictionary
        if i == "Pony":  # for Pony is more than one dork
            for j in dorks[i]:
                browser.get('http://www.google.com/search?q=' + j + "&t=h_&ia=web")
                links = browser.find_elements_by_xpath("//h3//a[@href]")
                for elem in links:
                    link = elem.get_attribute("href")
                    links_list.append(link)
            info.update({i: links_list})
            links_list = []

        else:
            browser.get('http://www.google.com/search?q=' + dorks[i] + "&t=h_&ia=web")
            links = browser.find_elements_by_xpath("//h3//a[@href]")
            for elem in links:
                link = elem.get_attribute("href")
                links_list.append(link)

            info.update({i: links_list})
            links_list = []

    if export_bool:
        try:
            export(directory, info)
            print("Exported to " + directory + '.txt')
        except OSError as e:
            print("Error " + e.strerror)

    elif output_bool:
        for i in info:
            print("-----------------------------")
            print(i)
            for j in info[i]:
                print(j)
        print("-----------------------------")

    else:
        print("Please add --output or --export")

    browser.quit()

    display.stop()
